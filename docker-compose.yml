version: "3.8"

services:
  # =====================================================
  # Base de Datos SQL Server
  # =====================================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: bp-sqlserver
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "BancoPichincha2026!"
      MSSQL_PID: "Developer"
      TZ: America/Guayaquil
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./BaseDatos.sql:/docker-entrypoint-initdb.d/BaseDatos.sql:ro
    networks:
      - bp-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "BancoPichincha2026!" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =====================================================
  # Aplicación Spring Boot
  # =====================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bp-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: docker

      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:sqlserver://sqlserver:1433;databaseName=BancoPichincha;encrypt=false;trustServerCertificate=true
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: "BancoPichincha2026!"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.microsoft.sqlserver.jdbc.SQLServerDriver

      # JPA/Hibernate Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.SQLServerDialect

      # Server Configuration
      SERVER_PORT: 8080

      # Java Options
      JAVA_OPTS: -Xmx512m -Xms256m -XX:+UseG1GC
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - bp-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# =====================================================
# Volúmenes
# =====================================================
volumes:
  sqlserver_data:
    driver: local
    name: bp-sqlserver-data

# =====================================================
# Redes
# =====================================================
networks:
  bp-network:
    driver: bridge
    name: bp-network
